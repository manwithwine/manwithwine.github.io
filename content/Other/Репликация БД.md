# Типы репликации

- pg_dump/pg_restore
- "способ с подпиской"

Сравнение со «снятием дампа»
- pg_dump/pg_restore — просто, но требует «окно» (чем больше данных, тем дольше).
- Логическая подписка — даёт миграцию с минимальным простоем: основная копия идёт онлайн, в конце короткая пауза для отставания + синхронизация последовательностей.

## pg_dump/pg_restore

### OPTION A

#### Cоздать на primary db-1 юзера БД, с которой хотим стянуть БД
Проверяем текущего юзера в configuration.py.

Создаем юзера:
```aiignore
docker exec -it patroni bash
psql -U postgres -d postgres -c "CREATE ROLE <uruser> LOGIN PASSWORD 'urpass';" 2>/dev/null || true
psql -U postgres -d postgres -c "ALTER ROLE <uruser> WITH LOGIN PASSWORD 'urpass';"
psql -U postgres -d postgres -c "CREATE DATABASE <uruser> OWNER <uruser>;" 2>/dev/null || true
psql -U postgres -d <uruser>    -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"
```

#### Проверить настройку postgres на VM с NB

```cat /etc/postgresql/14/main/postgresql.conf```

должно быть\
```listen_addresses = '*'```

Также добавить в /etc/postgresql/14/main/pg_hba.conf\
```host  <uruser>  <uruser>  <primary host ip>/32  md5```

#### restart service
```sudo systemctl restart postgresql```

#### check connection
```
docker exec -e PGPASSWORD='urpass' -it patroni bash -lc \
"psql -h <remote_ip> -p 5432 -U <uruser> -d <uruser> -c 'select 1;'"
```
#### if worked well create a dump
```
docker exec -e PGPASSWORD='urpass' -it patroni bash -lc '
pg_dump -h <remote_ip> -p 5432 -U <uruser> -d <uruser> \
  -Fc -f /home/postgres/pgdata/netbox_pg14.dump
```

### OPTION B
#### ssh tunnel in first terminal on db-1
```aiignore
ssh -N -L 15432:127.0.0.1:5432 login@<remote_ip>
```

#### dump via tunnel in other terminal window
```aiignore
docker exec -e PGPASSWORD='urpass' -it patroni bash -lc '
pg_dump -h 127.0.0.1 -p 15432 -U <uruser> -d <uruser> \
  -Fc -f /home/postgres/pgdata/netbox_pg14.dump
'
```

### NEXT - Import database into ur primary db

#### optional: faster commits during restore
```aiignore
docker exec -e PGPASSWORD='urpass' -it patroni bash -lc \
"psql -U <uruser> -h <haproxy_ip> -p 5432 -d <uruser> -c 'SET synchronous_commit=local;'"
```

#### restore (parallel)
```aiignore
docker exec -e PGPASSWORD='urpass' -it patroni bash -lc "
pg_restore -j 4 \
  -d 'postgresql://<uruser>@<haproxy_ip>:5432/<uruser>' \
  /home/postgres/pgdata/netbox_pg14.dump
"
```

#### analyze for good planner stats
```
docker exec -it patroni bash -lc '
vacuumdb -j 4 --analyze-in-stages \
  -d postgresql://<uruser>:urpass@<ip_address>>:5432/<uruser>
'
```


## «Cпособ с подпиской» — это логическая репликация PostgreSQL (publication/subscription).

Она как раз придумана для «почти безостановочной» миграции: 
- вы подключаете целевую БД (PG16 в Patroni-кластере) к исходной (PG14);
- данные копируются и дальше подтягиваются все изменения до самого момента переключения.

## Что важно знать заранее

- Откуда → Куда
  - Источник (publisher): netbox на <remote_ip>:5432
  - Приёмник (subscriber): ваш кластер за HAProxy (но подписку создаём на текущем лидере)

- Требования логической реплики
  - На источнике: wal_level = logical, достаточно max_wal_senders/max_replication_slots ≥ 5.
  - Все таблицы должны иметь PRIMARY KEY (у NetBox так и есть).
  - Последовательности (sequences) логической репликацией не гоняются. Их нужно синхронизировать в конце (дам скрипт).

- Права: логическая подписка подключается обычным логином (НЕ нужен флаг REPLICATION). Пользователь должен иметь SELECT на реплицируемые таблицы.

## Настройка

1. Настройка источника

- Включить логическую репликацию и перезапустить/перечитать конфиг
В postgresql.conf на источнике:
```
wal_level = logical
max_wal_senders = 10
max_replication_slots = 10

```

Перечитать:
```
sudo -u postgres psql -c "SELECT pg_reload_conf();"
```

Проверить:
```
SHOW wal_level;
```
должно быть logical.

- Разрешить доступ из кластера (pg_hba.conf)

```
-- на источнике (PG14)
CREATE ROLE repl_netbox LOGIN PASSWORD 'StrongReplPass!';
GRANT CONNECT ON DATABASE netbox TO repl_netbox;

\c netbox
GRANT USAGE ON SCHEMA public TO repl_netbox;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO repl_netbox;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO repl_netbox;

```

- Создать публикацию

Самый простой вариант — по всем таблицам схемы public:

```
\c netbox
CREATE PUBLICATION netbox_pub FOR ALL TABLES IN SCHEMA public;
```

2. Подготовка приёмника

Рекомендация: подключаться к локальному лидеру (а не через HAProxy), чтобы не ездить туда-сюда и понимать где живёт воркер подписки.

Понадобится, чтобы на приёмнике существовали:
- база netbox
- роль netbox (которой владеют таблицы) — она у вас уже есть
- при подписке воркер будет работать под владельцем подписки (обычно postgres)

3. Если на приёмнике нет данных (миграция «с нуля») — базовый путь

На лидере внутри контейнера:

```
docker exec -it patroni bash
psql -U postgres -d postgres -c "CREATE DATABASE netbox OWNER netbox;"
psql -U postgres -d netbox -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"

```

Создаём подписку (subscriber) — она сама скопирует данные и дальше будет стримить изменения:

```
-- на приёмнике (PG16, db-1), в БД netbox
CREATE SUBSCRIPTION netbox_sub
  CONNECTION 'host=IPADDRESS port=5432 dbname=netbox user=repl_netbox password=StrongReplPass!'
  PUBLICATION netbox_pub
  WITH (
    create_slot = true,
    slot_name   = netbox_sub,
    copy_data   = true,   -- ВАЖНО: скопировать стартовые данные
    streaming   = on,
    binary      = false   -- версии разные (14 -> 16), бинарный режим нельзя
  );

```

4. Если на приёмнике уже лежит дамп (как у вас) — «догоняем только изменения»

Тогда, чтобы не словить дубликаты, создаём подписку без начальной копии:

```
CREATE SUBSCRIPTION netbox_sub
  CONNECTION 'host=<remote_ip> port=5432 dbname=netbox user=repl_netbox password=StrongReplPass!'
  PUBLICATION netbox_pub
  WITH (
    create_slot = true,
    slot_name   = netbox_sub,
    copy_data   = false,  -- ВАЖНО: начальные данные уже есть
    streaming   = on,
    binary      = false
  );

```

В этом сценарии важно, чтобы схемы и набор таблиц совпадали: иначе подписка начнёт падать на несовпадении структур. Если сомневаетесь — лучше сделать schema-only дамп со старта, применить на приёмнике, а затем copy_data=true.

5. Мониторинг прогресса

На приёмнике:

```
-- состояние подписки
SELECT subname, status, received_lsn, latest_end_lsn, latest_end_time
FROM pg_stat_subscription;

-- активные COPY начальной загрузки (если copy_data=true)
SELECT * FROM pg_stat_progress_copy;

-- ошибки подписки
SELECT * FROM pg_subscription_rel WHERE srsubstate NOT IN ('r','s');

```

На источнике: 

```
-- слот логической репликации
SELECT slot_name, active, confirmed_flush_lsn FROM pg_replication_slots;

```

6. Финальная синхронизация последовательностей (ВАЖНО)

Последовательности (sequences) не реплицируются. Перед переключением:

На источнике (PG14, в БД netbox) сгенерируйте SQL для установки значений:

```
SELECT format(
  'SELECT setval(%L, %s, true);',
  quote_ident(n.nspname)||'.'||quote_ident(s.relname),
  (pg_catalog.pg_sequences.last_value)
)
FROM pg_class s
JOIN pg_namespace n ON n.oid = s.relnamespace
JOIN pg_sequences ON schemaname = n.nspname AND sequencename = s.relname
WHERE s.relkind='S' AND n.nspname='public';

```

Скопируйте получившиеся setval() и выполните на приёмнике (PG16) перед финальным переключением.
(Альтернатива — однократно выгрузить значения pg_dump -d netbox -s --section=post-data на источнике, вытащить из него блоки SELECT setval(...) и применить на приёмнике.)

7. Переключение (cutover)

- Перевести NetBox во временный read-only (или остановить приложение), чтобы после этого изменений на источнике не шло.
- Дождаться, что подписка догнала:

```
SELECT subname, (latest_end_time IS NOT NULL) AS caught_up
FROM pg_stat_subscription;
```
и нет отставания по LSN (поля latest_end_lsn ≈ received_lsn).

- Применить setval() для последовательностей на приёмнике.
- Отключить подписку:

```
ALTER SUBSCRIPTION netbox_sub DISABLE;
DROP SUBSCRIPTION netbox_sub;
```

На источнике можно:

```
DROP PUBLICATION netbox_pub;
```

- Переключить приложение NetBox на HAProxy RW (<ip_address>:5432) и снять read-only.

8. Что если лидер в кластере сменится во время подписки?

- Воркер подписки живёт на приёмнике (вашем кластере) и работает на текущем лидере Patroni. При failover подписка автоматически «переедет» на новый лидер.
- Главное — в pg_hba.conf источника разрешить все ваши хосты. Тогда новый лидер спокойно продолжит тянуть изменения.
