# Структура

IP пакет любой версии состоит из:

- управляющей информации = заголовка
- пользовательские данные

Структура IPv6:

![Структура](images/network/ipv6_4.jpg)  
*Source: [Курс: Основы протокола IPv6](https://clck.ru/3Mzm25)*


Сравнение IPv4 и IPv6 заголовков:

Основной заголовок IPv6 40 байт

Основной заголовок IPv4 20-60 байт

![Сравнение](images/network/ipv6_5.jpg)  
*Source: [Курс: Основы протокола IPv6](https://clck.ru/3Mzm25)*

Дополнительные отличия:

| Параметр         | IPv4                                 | IPv6                                                                |
|:-----------------|:-------------------------------------|:--------------------------------------------------------------------|
| Размер заголовка | 20–60 байт (переменный)              | 40 байт (фиксированный)                                             |
| Фрагментация     | Маршрутизаторы могут фрагментировать | Только отправитель <br/>(использует расширенный заголовок Fragment) |
| Checksum         | Есть в заголовке                     | Нет (контрольная сумма есть в TCP/UDP)                              |
| Опции            | Встроены в заголовок                 | Расширенные заголовки                                               |
| Multicast        | Широко используется (PIM DM, PIM SM) | Широко используется (например, для NDP)                             |


### Подробный разбор всех полей заголовка IPv6:

| Поле                | Размер (биты) | Описание                                                                                                                                                                                                                                                                  |
|:--------------------|:--------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Version             | 4             | Версия протокола (6 для IPv6).                                                                                                                                                                                                                                            |
| Traffic Class       | 8             | Приоритет трафика (аналог ToS в IPv4, используется для QoS).                                                                                                                                                                                                              |
| Flow Label          | 20            | Метка потока (используется для управления качеством обслуживания). <br>Позволяет отправителю пометить последовательность пакетов, которая должна рассматриваться как единый поток. <br>Если значение не 0, маршрутизаторы и балансировщики обрабатывают пакеты одинаково. |
| Payload Length      | 16            | Длина полезной нагрузки (в байтах), без учёта заголовка. <br>Заголовки расширения = полезная нагрузка                                                                                                                                                                     |
| Next Header         | 8             | Указывает тип следующего заголовка (например, 6 = TCP, 17 = UDP или заголовок расширений).                                                                                                                                                                                |
| Hop Limit           | 8             | Максимальное число переходов (аналог TTL в IPv4). <br>Уменьшается на 1 каждый раз, когда пакет проходит через устройство.                                                                                                                                                 |
| Source Address      | 128           | IPv6-адрес отправителя.                                                                                                                                                                                                                                                   |
| Destination Address | 128           | IPv6-адрес получателя.                                                                                                                                                                                                                                                    |


## Расширенные заголовки

| Номер | Название                             | RFC      | Описание                                                                                                  |
|:------|:-------------------------------------|:---------|:----------------------------------------------------------------------------------------------------------|
| 0     | Hop-by-Hop Options                   | RFC 8200 | Опции, обрабатываемые каждым маршрутизатором на пути.<br/>Используется для Jumbograms (RFC 2675), Router Alert (RFC 2711) |
| 43    | Routing                              | RFC 8200 | Управление маршрутизацией (например, Segment Routing)                                                     |
| 44    | Fragment                             | RFC 8200 | Фрагментация пакета (только отправителем)                                                                 |
| 50    | Encapsulating Security Payload (ESP) | RFC 4303 | IPSec: шифрование данных                                                                                  |
| 51    | Authentication Header (AH)           | RFC 4302 | IPSec: аутентификация (без шифрования)                                                                    |
| 60    | Destination Options                  | RFC 8200 | Опции, обрабатываемые только получателем.<br/>Пример: Mobility Support (RFC 6275).                        |
| 59    | No Next Header                       | RFC 8200 | Обозначает конец цепочки заголовков                                                                       |


### Порядок заголовков в пакете

Рекомендуемый порядок (RFC 8200):

1. Основной заголовок IPv6
2. Hop-by-Hop Options (если есть)
3. Destination Options (если есть, и обрабатывается первым получателем)
4. Routing
5. Fragment 
6. Authentication Header (AH)
7. Encapsulating Security Payload (ESP)
8. Destination Options (если есть, и обрабатывается конечным получателем)
9. Upper-Layer Protocol (TCP/UDP/ICMPv6)
