# Multicast

В IPv6 multicast (многоадресная рассылка) играет ключевую роль — он заменяет широковещательный трафик (broadcast) из IPv4.

Используется для служебных протоколов (NDP, SLAAC) и групповых приложений.

## Зарезирвированные мультикастовые адрес

- ff02::1 - все узлы
- ff02::2 - все маршрутизаторы на канале
- ff05::2 - все маршрутизаторы на сайте
- ff02::1:ffXX:XXXX - адрес запрошенного узла (Solicited-Node Multicast) в протоколе NDP.
- ff02::1:2 - все DHCPv6-серверы/агенты
- ff0e::101 - NTP серверы
- ff0e::102 - групповые видеопотоки

Последние 32 бита мультикаст адреса в IPv6 образуют идентификатор multicast групп (Group ID). Он задает зону действия этого адреса.

## Solicited-Node Multicast

Замена ARP из IPv4, используется в NDP для разрешения MAC-адресов.

Формат: ff02::1:ffXX:XXXX, где XX:XXXX — последние 24 бита unicast-адреса устройства.

Пример:

- Unicast: 2001:db8::abcd:1234
- Последние 24 бита: **cd:1234**
- Префикс multicast адреса: _ff02::1:ff_**XX:XXXX**
- Результат: _ff02::1:ff_**cd:1234**

### Пример процедуры выяснения MAC-адреса соседа в IPv6

Допустим, у нас есть 3 устройства в одной подсети /64:

| Устройство | IPv6-адрес  | MAC-адрес                  |
|:-----------|:------------|:---------------------------|
| Host A     | 2001:db8::1 | 00:11:22:33:44:55          |
| Host B     | 2001:db8::2 | aa:bb:cc:dd:ee:ff          |
| Host C     | 2001:db8::3 | 12:34:56:78:9a:bc          |

**Задача:**
Host A (2001:db8::1) хочет узнать MAC-адрес Host B (2001:db8::2).

**Сам процесс:**

1. Все хосты заранее вычисляют свои Solicited-Node Multicast (SNM) адреса на основе своих IPv6 и начинают их слушать.
Например, Host B = 2001:db8::2 → ff02::1:ff00:2 (по алгоритму описанному ранее)

2. Когда Хост A (2001:db8::1) хочет найти MAC для 2001:db8::2 (чей MAC неизвестен):
 - Вычисляет SNM цели (2001:db8::2 → ff02::1:ff00:2).
 - Отправляет **Neighbor Solicitation (NS)** на этот SNM-адрес. (source_ip, source_mac, dest_snm)

3. Только Хост B (так как его IPv6 соответствует ff02::1:ff00:2) отвечает своим MAC.
- Host C игнорирует запрос, т.к. его IPv6 (::3) не соответствует multicast-группе ff02::1:ff00:2
- Host B отвечает **Neighbor Advertisement (NA)**. При этом отвечает на Unicast адрес Host A (2001:db8::1)
4. Host A получает ответ и записывает в кеш соседей (Neighbor Cache)

## Протокол обнаружения дубликатов адресов (DAD - Duplicate Address Detection) в IPv6

Проверка, что IPv6-адрес, который хочет использовать хост, уникален в локальной сети.\
Если адрес уже занят, хост отказывается от его использования.

### Как работает DAD?

1. Хост генерирует временный адрес (обычно из FE80::/10 для link-local или полученного через SLAAC/DHCPv6).
2. Отправляет Neighbor Solicitation (NS) на соответствующий Solicited-Node Multicast (SNM) этого адреса:
- Целевой адрес = проверяемый IPv6 (но пока не назначен). 
- Source IPv6 = :: (неопределённый адрес, так как хост ещё не уверен в уникальности). 
- Destination IPv6 = SNM-адрес проверяемого IPv6.
3. Ожидание ответа:
- Если никто не ответил → адрес уникален, хост начинает его использовать.
- Если пришёл Neighbor Advertisement (NA) → адрес уже занят, хост отвергает его.\
Следовательно, необходимо повторить процедуру получения/заново сгенерировать и повторить действия п.2

Доп детали:
- Время ожидания: Обычно 1-2 секунды (зависит от реализации). 
- Без DAD хост не активирует адрес (это критично для стабильности сети). 
- RFC 4862 (IPv6 Stateless Address Autoconfiguration) регламентирует процесс.

## Multicast Listener Discovery (MLD) в IPv6

**MLD (Multicast Listener Discovery)** — это протокол, используемый в IPv6 для управления подписками на multicast-группы.\
Он является аналогом IGMP (Internet Group Management Protocol) из IPv4, но оптимизирован для IPv6 и интегрирован в ICMPv6.

### Версии MLD

- MLDv1 (RFC 2710) - Базовая поддержка подписки на multicast. (Аналог IGMPv2)

- MLDv2 (RFC 3810) - Добавлена поддержка source-specific multicast (SSM) — фильтрация по источнику. (Аналог IGMPv3)

#### Отличия от IGMP

| Характеристика         | IGMP (IPv4)             | MLD (IPv6)                            |
|------------------------|-------------------------|:--------------------------------------|
| Тип протокола          | Отдельный протокол      | Встроен в ICMPv6                      |
| Multicast-адреса       | 224.0.0.0/4             | ff00::/8                              |
| Сообщения              | IGMP Query/Report/Leave | MLD Query/Report/Done(только в MLDv1) |
| Фильтрация источников  | Только в IGMPv3         | Есть в MLDv2                          |


### Принцип работы

Основные сообщения:

1. Multicast Listener Query (тип 130)

 - Отправляется маршрутизатором, чтобы узнать, какие группы активны.
 - Бывает двух типов:
   - General Query — запрос всех multicast-групп. 
   - Group-Specific Query — запрос для конкретной группы.
 - В MLDv2 есть SSM (Source-Specific Multicast) - можно выбрать конкретные источники\
Также в MLDv2 можно указать белые/чёрные списки источников.

2. Multicast Listener Report (тип 131)
 - Отправляется хостом в ответ на Query или при желании присоединиться к группе. 
 - Говорит маршрутизатору: "Я хочу получать трафик этой группы".

3. Multicast Listener Done (тип 132, только в MLDv1)
 - В MLDv2 - Done встроен в Report
 - Хост сообщает, что больше не хочет получать multicast.

_Интересная штука:\
Если хотя бы один из хостов использует MLDv1, а все остальные v2, то все начнут использовать v1_
