# Asymmetric vs Symmetric IRB

EVPN гибко управляет L2-доменами и VLAN'ами поверх IP-сети. Но настоящая сила современного дата-центра заключается не просто в растягивании L2, а в бесшовной интеграции L2 и L3 — возможности маршрутизировать трафик (L3) прямо на том же устройстве.

Именно здесь на сцену выходит **Integrated Routing and Bridging (IRB)** — механизм, который позволяет VTEP (VXLAN Tunnel End Point) в EVPN выполнять как коммутацию (Bridging) внутри L2-домена, так и маршрутизацию (Routing) между ними.

Однако, возникает ключевой вопрос: где именно происходит переход из L2 в L3? \
На каком устройстве фрейм превращается в пакет? 

В зависимости от ответа на этот вопрос, существует две фундаментальные архитектуры: **Asymmetric IRB** и **Symmetric IRB**.

**В чем между ними разница?** \
Разница в том, как выполняется lookup для маршрутизации.

Рассмотрим следующий пример:

![Схема:](images/network/evpn_5.jpg)

SRV-1 отправляет ICMP Echo request в сторону SRV-4.

### Asymmetric IRB

**Маршрутизация происходит только на Ingress лифе (где трафик входит в EVPN Fabric). 
Egress лиф выполняет только L2 forwarding (bridging).**

Процесс отправки на примере выше:
```aiignore
- SRV-1 отправляет пакет в LEAF-1 с destination MAC = SVI LEAF-1.
- LEAF-1 производит L2 lookup и видит собственный MAC. Следовательно, пакет должен быть маршрутизирован.
- LEAF-1 производит L3 lookup, основываясь на VRF привязанный к SVI. Пакет нужно отправить в сторону SVI VLAN 20
- LEAF-1 проверяет ARP cache в поисках MAC address SRV-4.
- LEAF-1 проверяет MAC address таблицу, чтобы найти нужный VTEP, за которым находится SRV-4.
- LEAF-1 берет VNI ассоциированный с этим VLAN.
- LEAF-1 энкапсулирует пакет и отправляет в сторону LEAF-4.
- LEAF-4 выполняет декапсуляцию.
- LEAF-4 производит L2 lookup основываясь га VNI и destination MAC пакета.
- LEAF-4 отправляет пакет в сторону SRV-4.
```

Вот как это будет выглядеть на схеме:

![Asymmetric:](images/network/evpn_6.jpg)


Более простым языком:\
Leaf-1 маршрутизируют из VNI10000 в VNI20000 и отправляет по L2 на Leaf-4, после Leaf-4 просто отправляет пакет по L2 до Server-4.\
Обратный пакет из VNI20000 маршрутизируется по L3 в VNI10000 и по L2 отправляется до Leaf-1

Получается ассиметричная схема:
```aiignore
LEAF1 (L2 - L3 - L2) -> (L2) LEAF4  <=> LEAF4 (L2 - L3 - L2) -> (L2) LEAF1
```

т.е. лифы выполняют не одинаковые действия.

Следовательно, для Asymmetric необходимо синхронизировать свои конфигурации и настроить все VLAN, SVI и VNI на всех VTEP.

### Symmetric IRB

**Маршрутизация происходит и на Ingress, и на Egress лифах (L3 lookup).**

Используем тот же пример, только теперь добавится L3 VNI = 100001 на обоих лифах.

Процесс отправки:
```aiignore
- SRV-1 отправляет пакет в LEAF-1 с destination MAC = SVI LEAF-1.
- LEAF-1 производит L2 lookup и видит собственный MAC. Следовательно, пакет должен быть маршрутизирован.
- LEAF-1 производит L3 lookup, основываясь на VRF привязанный к SVI. Пакет нужно отправить в сторону L3 VNI
- LEAF-1 инкапсулирует пакет и устанавливает L3 VNI и destination MAC внутреннего заголовка Ethernet на Local Router MAC-адрес LEAF-4.
- LEAF-4 декапсулирует пакет.
- LEAF-4 выполняет L3 lookup основываясь на VNI и находит локальный маршрут в сторону SRV-4.
- LEAF-4 проверяет ARP cache, чтобы найти MAC-адрес хоста SRV-4.
- LEAF-4 проверяет MAC address таблицу, чтобы найти порт, в который подключен SRV-4.
- LEAF-4 отправляет пакет в сторону хоста SRV-4.

```

Вот как это будет выглядеть на схеме:

![Symmetric:](images/network/evpn_7.jpg)  

Следовательно, получается симметричная схема:
```aiignore
LEAF1 (L2 - L3) -> (L3 - L2) LEAF4  <=> LEAF4 (L2 - L3) -> (L3 - L2) LEAF1
```

т.е. оба лифа выполняют одинаковые операции (L2/3 lookup)

Получаем, что преимущество Symmetric IRB  в том, что нет необходимости создавать все L2 VNI, VLAN и SVI для сетей, которые не будут использоваться на каждом VTEP.


*Source: [Daniels Networking Blog](https://clck.ru/3Pcznn)*
