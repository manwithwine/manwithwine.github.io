# VLAN-Based, VLAN-Aware и VLAN-Bundle в EVPN

Итак, мы понимаем, что EVPN позволяет "протягивать" L2-домены через L3-сеть.\
Но как именно EVPN взаимодействует с классическими Ethernet-фреймами и их VLAN-тегами?

Здесь возникает ключевое решение: как отображать VLAN'ы на виртуальные сети внутри EVPN.\
В зависимости от требований к гибкости и масштабируемости, существует три основных модели:

![Три модели:](images/network/evpn_1.jpg)  
*Source: [Juniper](https://clck.ru/3PcouX)*

## VLAN-based - каждый VLAN/VNI получает выделенный mac-vrf

![VLAN-based:](images/network/evpn_2.jpg)  
*Source: [Juniper](https://clck.ru/3PcouX)*

```aiignore
Аналогия: 
Представьте, что у вас есть несколько независимых компаний в одном здании. 
Для каждой компании вы выделяете отдельный лифт (EVPN-Instance). 
Лифт №1 только для компании "А", Лифт №2 только для компании "Б". Они никак не связаны.
```

**Как работает:**
- Создается отдельный Broadcast Domain (BD) и, что ключево, отдельный EVPN-Instance (EVI) для каждого VLAN'а. 
- Каждый EVI имеет свой уникальный Route Distinguisher (RD) и Route Target (RT). 
- Устройствам CE (например, серверам) обычно передается "голый" (untagged) или с одним тегом (tagged) трафик.

**За что отвечает:**\
За простую организацию сети, где у каждого сервиса (VLAN) своя полностью изолированная виртуальная overlay-сеть. Это прямолинейно, но плохо масштабируется — 1000 VLAN'ов означают 1000 EVI, RD и RT на каждом PE-маршрутизаторе.

## VLAN-aware - несколько VLAN/VNI под одним mac-vrf

![VLAN-aware:](images/network/evpn_3.jpg)  
*Source: [Juniper](https://clck.ru/3PcouX)*

```aiignore
Аналогия: 
Теперь у вас в здании один большой и умный лифт (EVI) на все компании. 
Когда сотрудник заходит в лифт, он нажимает кнопку своего этажа (VLAN ID). 
Система лифта "осведомлена" о разных этажах и может доставить каждого куда нужно.
```

**Как работает:**
- Создается один EVI для группы VLAN'ов. 
- Используется один RD, но для импорта/экспорта маршрутов используются расширенные сообщения EVPN (например, MAC/IP Advertisement с VLAN-тегом). 
- Внутри этого EVI существует несколько Broadcast Domain'ов (по одному на VLAN), и маршрутизатор понимает, к какому BD принадлежит фрейм, основываясь на его VLAN ID (теге 802.1Q).

**За что отвечает:**\
За масштабируемость и консолидацию. Вы можете передавать десятки или сотни VLAN'ов через один экземпляр EVPN, что резко сокращает количество BGP-сущностей (EVI, RT) и упрощает управление.\
Это современный и рекомендуемый подход для большинства сценариев.

## VLAN-bundle - несколько VLAN под одним mac-vrf с использованием одного VNI

![VLAN-bundle:](images/network/evpn_4.jpg)  
*Source: [Juniper](https://clck.ru/3PcouX)*

```aiignore
Аналогия: 
У вас снова один лифт (EVI) для нескольких компаний, но теперь все они арендуют открытое пространство на одном этаже. 
У сотрудников нет отдельных кабинетов (VLAN ID не используется для разделения внутри overlay). 
Все находятся в общем пространстве.
```

**Как работает:**
- Это упрощенная версия VLAN-Aware. 
- Создается один EVI для группы VLAN'ов, и на маршрутизаторах PE все эти VLAN'ы отображаются в один общий Broadcast Domain. 
- VLAN ID отбрасывается при отправке трафика через underlay. Это означает, что на принимающей стороне PE-маршрутизатор не знает, в каком исходном VLAN был фрейм, и помещает его в свой локальный VLAN из этого "пакета".

**За что отвечает:**\
За упрощение конфигурации в строго определенных сценариях, где все VLAN'ы на всех участках сети идентичны и не требуется сохранять изоляцию на уровне overlay между ними. Встречается реже, так как потеря информации о VLAN является серьезным ограничением.

