# Приоритет маршрутов в EVPN/VXLAN для Symmetric/Asymmetric  IRB

!!!!!!!!!!!!!!НАДО ПОПРАВИТь ТЕКСТ!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


В симметричном IRB приоритетным маршрутом для связи между узкими сетями (subnets) является Type5 (IP Prefix Route), потому что он явно и наиболее эффективно описывает маршрут до целой подсети, расположенной на удаленном VTEP. Type2 (MAC/IP Route) используется для связи внутри одной подсети (L2) и для разрешения ARP.

В асимметричном IRB для межподсетевой маршрутизации используется только Type2, так как маршрутизация происходит только на ingress VTEP.

Детальное объяснение
1. Симметричный IRB (Symmetric IRB)
Принцип: Маршрутизация (L3) происходит как на ingress, так и на egress VTEP. Каждый VTEP выполняет функции и L2, и L3 шлюза для своих подсетей.

Какие маршруты отправляются?

Type2 (MAC/IP Advertisement Route):

Что содержит: MAC-адрес + IP-адрес хоста (если есть).

Зачем нужен:

Для L2 связности: Построение таблицы MAC (MAC-VRF) для bridging-домена (VLAN) между VTEP.

Для разрешения ARP/ND: Удаленные VTEP могут ответить на ARP-запросы для хостов в своих подсетях, не пересылая широковещательный трафик.

Для L3 связности: В симметричной модели он используется для установки связки "IP -> VTEP" в таблице маршрутизации (IP-VRF), но только для хостов с известными IP (/32 или /128 маршруты).

Type5 (IP Prefix Route):

Что содержит: IP-префикс (подсеть, например, 10.1.10.0/24) + Next Hop (IP VTEP'а).

Зачем нужен: Это основной маршрут для межподсетевой маршрутизации. Он явно сообщает всем VTEP в EVPN-домене: "Подсеть 10.1.10.0/24 находится за мной (VTEP-IP)".

Почему Type5 является приоритетным для межподсетевого трафика?

Допустим, у нас есть:

VTEP-1: Хост A (IP-A) в подсети 10.1.10.0/24.

VTEP-2: Хост B (IP-B) в подсети 10.2.20.0/24.

VTEP-1 объявляет два маршрута:

Type2: MAC-A + IP-A

Type5: 10.1.10.0/24

VTEP-2 изучает эти маршруты. Когда Host B хочет связаться с Host A, трафик приходит на VTEP-2.

Таблица маршрутизации (IP-VRF) на VTEP-2:

10.1.10.0/24 [Type5] -> next-hop VTEP-1

IP-A/32 [Type2] -> next-hop VTEP-1

Процесс поиска маршрута (Longest Prefix Match):

Пакет предназначен для IP-A.

Оба маршрута ведут к одному и тому же Next Hop (VTEP-1).

Но маршрут /32 (созданный из Type2) является более специфичным, чем маршрут /24 (созданный из Type5).

ОШИБОЧНОЕ предположение: Казалось бы, должен использоваться Type2.

Ключевой момент (EVPN Order of Preference):
В EVPN существует четкое правило приоритета при установке маршрутов в RIB/FIB:

Type5 > Type2

То есть, если существует и Type5 (префикс), и Type2 (/32 хост) для одного и того же назначения, контролер маршрутизации (BGP) предпочтет Type5. Это сделано намеренно, чтобы агрегировать трафик на уровне подсетей и избежать необходимости устанавливать миллионы /32 маршрутов для каждого хоста.

Вывод для Symmetric IRB: Type5 — это "магистральный" маршрут для всей подсети. Type2 используется для L2, ARP и как резервный или уточняющий маршрут (например, для хостов с мигрирующими ВМ или в специфичных сценариях).

2. Асимметричный IRB (Asymmetric IRB)
Принцип: Маршрутизация (L3) происходит только на ingress VTEP. Egress VTEP получает трафик уже в кадре L2, предназначенном для целевой подсети.

Какие маршруты отправляются?

Type2 (MAC/IP Advertisement Route): Это единственный и достаточный маршрут для межподсетевой связи.

Он содержит IP-адрес удаленного хоста и его MAC-адрес.

Как это работает?

VTEP-1: Хост A (IP-A, MAC-A) в VLAN 10 (L2VNI 10010).

VTEP-2: Хост B (IP-B, MAC-B) в VLAN 20 (L2VNI 10020). VTEP-2 также является шлюзом по умолчанию для своей подсети (MAC-GW).

VTEP-2 объявляет Type2 маршрут: MAC-B + IP-B.

VTEP-1 изучает этот маршрут. Теперь он знает, что IP-B ассоциирован с MAC-B и находится на VTEP-2.

Процесс отправки трафика от A к B:

Host A отправляет пакет на свой шлюз (VTEP-1), так как IP-B в другой подсети.

На VTEP-1 (ingress):

Выполняется поиск в IP-таблице. Найден маршрут: IP-B -> next-hop VTEP-2.

Но для асимметричного IRB это не IP-маршрут, а указание: "заверни пакет в VXLAN с L2VNI целевого хоста".

VTEP-1 меняет MAC-адрес назначения на MAC-B, а MAC-источника — на свой собственный (или на MAC-GW).

VTEP-1 инкапсулирует L2 кадр в VXLAN, используя L2VNI VLAN 20 (10020) и отправляет на VTEP-2.

На VTEP-2 (egress):

Получает пакет, декапсулирует его.

Видит, что это L2-кадр с MAC-назначения = MAC-B в его локальном VLAN 20.

Не выполняя L3-маршрутизацию, VTEP-2 пересылает кадр хосту B через L2-интерфейс.

Почему в Asymmetric IRB не нужен Type5?
Потому что egress VTEP не нуждается в знании IP-маршрута до подсети Host A. Ему нужно только знать L2-маршрут до Host B (через Type2). Вся маршрутизация и подмена MAC-адресов выполняется один раз — на ingress VTEP.

| Параметр | Симметричный IRB (Symmetric) | Асимметричный IRB (Asymmetric) |
| :--- | :--- | :--- |
| **Принцип маршрутизации** | На ingress и egress VTEP | Только на ingress VTEP |
| **Основной маршрут для межподсети** | **Type 5 (IP Prefix Route)** | **Type 2 (MAC/IP Route)** |
| **Роль Type 2** | L2 связность, ARP, /32 хосты | **L2 связность + межподсетевая маршрутизация** |
| **Роль Type 5** | **Основной для межподсетевого трафика** | Не используется |
| **Использование VNI** | L2VNI (для L2) + L3VNI (для L3) | Только L2VNI |
| **Эффективность** | Выше (один VXLAN заголовок) | Ниже (hair-pinning через локальный шлюз) |
| **Масштабируемость** | Лучше (агрегация через Type 5) | Хуже (только /32 маршруты через Type 2) |
| **Сложность** | Выше | Ниже |

## Дополнительные типы маршрутов EVPN

| Тип | Назначение | Используется в |
| :--- | :--- | :--- |
| **Type 1** (Ethernet Auto-Discovery) | Обнаружение VTEP, массовый вывод из строя | Обе модели |
| **Type 2** (MAC/IP Advertisement) | MAC-和学习, ARP suppression, межподсетевая маршрутизация (Asymmetric) | Обе модели |
| **Type 3** (Inclusive Multicast Ethernet Tag) | Формирование BUM-трафика (широковещание, неизвестные unicast) | Обе модели |
| **Type 4** (Ethernet Segment) | Multi-homing (All-Active, Single-Active) | Обе модели |
| **Type 5** (IP Prefix Route) | Межподсетевая маршрутизация (Symmetric) | Только Symmetric IRB |

Заключение
Symmetric IRB — это современная, эффективная и масштабируемая модель. Type5 в ней является приоритетным, так как он представляет собой агрегированный маршрут уровня подсети, что соответствует принципу "маршрутизируй once, коммутируй много".

Asymmetric IRB — это более простая, но менее эффективная историческая модель, которая полагается исключительно на Type2 маршруты для всей связности, что приводит к "hair-pinning" трафику через локальный шлюз и менее оптимальным путям пересылки.